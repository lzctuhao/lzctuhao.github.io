(function(){function e(e,o){return function(s,t,a=o,n="inherit"){const l=`border-radius:5px; background-color: ${a}; color: white; padding:1px 5px; margin-right: 5px;`;const c=`color: ${n};`;e(`%c${s}%c${t}`,l,c)}}console.tag=e(console.log,"forestgreen");console.tag.warn=e(console.warn,"orange");console.tag.error=e(console.error,"red");console.tag.info=e(console.log,"lightblue")})();importScripts("/libs/workbox/workbox-sw.js");workbox.setConfig({modulePathPrefix:"/libs/workbox/",debug:false});if(workbox){console.tag("sw.js","Workbox loaded successfully with local modules")}else{console.tag.error("sw.js","Workbox failed to load")}self.addEventListener("activate",(e=>{e.waitUntil(self.clients.claim())}));self.addEventListener("message",(e=>{if(e.data&&e.data.type==="SKIP_WAITING"){self.skipWaiting()}}));if(workbox.navigationPreload.isSupported()){workbox.navigationPreload.enable()}const CACHE_NAME={html:"html-xml-json-cache",css_js:"css-js-cache",local_image:"local-image-cache",nonlocal:"nonlocal-cache",local_media:"local-media-cache",font:"font-cache",unsplash:"unsplash-cache"};self.addEventListener("fetch",(e=>{const o=new URL(e.request.url);if(o.hostname==="source.unsplash.com"){console.tag("Unsplash","Intercepting Unsplash request:"+e.request.url);e.respondWith(handleUnsplashRequest(e.request));return}if(e.request.mode==="navigate"){e.respondWith((async()=>{try{const o=await e.preloadResponse;if(o)return o;const s=await fetch(e.request);if(!s.ok)throw new Error("Fetch failed");return s}catch(e){console.tag.error(e);const o=await caches.open(CACHE_NAME.html);const s=await o.match("/offline.html");return s}})())}}));async function resolveUnsplashImageUrl(e=null,o=null,s=null){const t="HDbS2nAmPx8B4FKmzLYF3FEBUhbxXTtJcTyzdQCJr3M";const a="CBPlaRQlVQo";const n="oYVLJL33vS3DByXadKLvBAoRJ_6x_G1kgsYeC4mPpiw";try{let l=null;let c=e;let r=false;if(e){let o=1;const s=30;while(true){const n=`https://api.unsplash.com/collections/${a}/photos?client_id=${t}&page=${o}&per_page=${s}`;const l=await fetch(n);if(!l.ok)throw new Error("Failed to check collection");const c=await l.json();if(c.some((o=>o.id===e))){r=true;console.tag("Unsplash",`Photo ${e} found in collection`);break}if(c.length<s)break;o++}}const i=e?`https://api.unsplash.com/photos/${e}?client_id=${t}`:`https://api.unsplash.com/photos/random?client_id=${t}`;const h=await fetch(i);if(!h.ok)throw new Error("Failed to fetch photo");const p=await h.json();l=p.urls.regular;c=p.id;if(e&&!r){const e=`https://api.unsplash.com/collections/${a}/add?access_token=${n}`;const o=await fetch(e,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({photo_id:c})});if(o.ok){console.tag("Unsplash",`Photo ${c} added to collection`)}else{console.tag.warn("Unsplash",`Failed to add photo ${c} to collection`)}}if(o&&s){const e=new URLSearchParams({w:o,h:s,fit:"crop",crop:"faces,entropy",auto:"compress"});l+=`?${e.toString()}`}return l}catch(e){console.tag.error("Unsplash",`Error resolving image URL: ${e}`);Toast.fire("无法获取图片，请稍后重试");return null}}async function precacheUnsplashPhoto(e,o=null,s=null){try{const t=await resolveUnsplashImageUrl(e,o,s);const a=await fetch(t);if(a.ok){const e=await caches.open("unsplash-cache");await e.put(t,a.clone());console.tag("sw.js","Precached Unsplash image:"+t)}}catch(o){console.tag.warn("Unsplash",`Error precaching Unsplash photo:${e}, ${o}`)}}async function handleUnsplashRequest(e){const o=e.url;const s=o.match(/https:\/\/source.unsplash.com\/([-\w]+)?\/?(\d+)?x?(\d+)?/);if(!s)return fetch(e);const[t,a,n,l]=s;try{const e=await resolveUnsplashImageUrl(a,n,l);const o=await caches.open("unsplash-cache");const s=await o.match(e);if(s){console.tag("Unsplash","Serving from cache:"+e);return s}const t=await fetch(e);if(t.ok){o.put(e,t.clone());console.tag("Unsplash","Cached new image:"+e)}return t}catch(o){console.tag.error("Unsplash",`Failed to handle Unsplash request: ${o}`);return fetch(e)}}self.addEventListener("install",(e=>{e.waitUntil((async()=>{await precacheUnsplashPhoto("iYsGZgoS6bM",800,600);await precacheUnsplashPhoto("G9i_plbfDgk",1200,800)})())}));workbox.routing.registerRoute(/\.(css|js)$/,new workbox.strategies.StaleWhileRevalidate({cacheName:CACHE_NAME.css_js,plugins:[new workbox.expiration.ExpirationPlugin({maxAgeSeconds:7*24*60*60})]}));workbox.routing.registerRoute(/(lzc|localhost:4000)\S+(\.(?:png|jpg|jpeg|svg|webp|gif))$/,new workbox.strategies.CacheFirst({cacheName:CACHE_NAME.local_image}));workbox.routing.registerRoute(/^((?!lzc|localhost).)*$/,new workbox.strategies.StaleWhileRevalidate({cacheName:CACHE_NAME.nonlocal}));workbox.routing.registerRoute(/(lzc|localhost:4000)\S+(\.(?:mp3|mp4|mkv|vtt|ogg|wav|webm))$/,new workbox.strategies.CacheFirst({cacheName:CACHE_NAME.local_media}));workbox.routing.registerRoute(/\.(?:woff2|eot|ttf|woff|otf)$/,new workbox.strategies.CacheFirst({cacheName:CACHE_NAME.font}));workbox.routing.registerRoute(/\.(?:xml|html|json)$/,new workbox.strategies.NetworkFirst({cacheName:CACHE_NAME.html}));function safeAddAll(e,o){caches.open(e).then((async e=>{for(const s of o){try{const o=await fetch(s);if(o.ok){await e.put(s,o.clone());console.tag("sw.js",`Precached: ${s}`)}else{console.tag.warn("sw.js",`Failed to fetch: ${s}`)}}catch(e){console.tag.warn("sw.js",`Error fetching: ${s}`+e)}}}))}safeAddAll(CACHE_NAME.html,["/","/offline.html","/tools/","/tools/index.html","/tools/poster/index.html","/tools/formula_format/index.html","/tools/calculator/index.html","/tools/tools-pc.html"]);const cssFiles=["/libs/materialize/materialize.min.css","/libs/sweetalert/sweetalert2.11.css","/css/matery.css","/css/matery-dark.css","/css/standalone/poster.css","/css/standalone/poster-result.css","/css/standalone/wordlist.css"];const jsFiles=["/libs/sweetalert/sweetalert2.11.js","/js/materialize.min.js","/js/matery.js","/libs/aos/aos.js","/js/standalone/jump2pc.js","/js/standalone/add2home.js","/js/standalone/calculator.js","/js/standalone/dom-to-image-more.js","/js/standalone/formula_format.js","/js/standalone/poster.js","/js/standalone/textbox_handle.js"];safeAddAll(CACHE_NAME.css_js,[...cssFiles,...jsFiles]);