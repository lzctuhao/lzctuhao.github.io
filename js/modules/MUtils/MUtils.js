(function(e){e.update_URLParams=function(e,...t){const n=new URLSearchParams(e.split("?")[1]||"");for(let e=0;e<t.length;e+=2){if(t[e+1]==="")n.delete(t[e]);else n.set(t[e],t[e+1])}return`${e.split("?")[0]}?${n.toString()}`},e.URLParam=function(e,t=null,n=window.location.href){let r=new URL(n);const a=new URLSearchParams(r.search);if(t===null){let t=a.get("clear");if(t){t.split(",").forEach((t=>{if(e==t&&a.get(t)){this.URLParam(t,"",n)}}))}let r=a.get(e);r=MUtils.safeParse(r);if(e=="password"){try{r=atob(r)}catch{console.warn("无法解码"+e)}}return r}else{let r=this.update_URLParams(n,e,t);if(n==window.location.href){window.history.replaceState({},"",r)}return r}},e.loadFile=function(e){return new Promise(((t,n)=>{const r=/\.(\w+)$/.exec(e);if(!r){n(new Error("Invalid file name"));return}const a=r[1];let s,o;if(a==="js"){s="script";o="src"}else if(a==="css"){s="link";o="href"}else{n(new Error("Unsupported file type"));return}const i=document.querySelectorAll(s);for(let n=0;n<i.length;n++){if(i[n].getAttribute(o)===e){t("File already loaded");return}}const l=document.createElement(s);if(a==="css"){l.rel="stylesheet";l.type="text/css"}else{l.type="text/javascript"}l[o]=e;l.onload=()=>t("File loaded successfully");l.onerror=()=>n(new Error("Error loading file"));document.head.appendChild(l)}))},e.loadScriptsSequentially=function(e){function t(n){if(n>=e.length)return;var r=document.createElement("script");r.src=e[n][0];r.defer=true;r.onload=function(){if(e[n][1]){e[n][1]()}t(n+1)};document.head.appendChild(r)}t(0)},e.unsplash_new=async function(e,t=1,n="regular"){console.tag("Unsplash","now searching page "+t);const r=7*24*60*60*1e3;const a=(new Date).getTime();const s="unsplash-cache";let o;if(typeof caches!=="undefined"){o=await caches.open(s);const t=await o.match(e);if(t){const n=await t.json();console.tag("Unsplash",`Cache for ${e} found.`);if(a-n.timestamp<r){return n.result}}}const i=4;const l=e.match(/https:\/\/source.unsplash.com\/([-\w]+)?\/?(\d+)?x?(\d+)?/);if(!l){throw new Error("Invalid URL format.")}let[c,u,p,f]=l;if(!u){u="";console.warn(u);const t=await d();await m(e,t);return t}try{console.tag("Unsplash",t+"finding_page");const r=await $.ajax({url:`https://api.unsplash.com/collections/CBPlaRQlVQo/photos/?client_id=HDbS2nAmPx8B4FKmzLYF3FEBUhbxXTtJcTyzdQCJr3M&per_page=30&page=${t}`,method:"GET",dataType:"json"});let a=false;for(let t of r){if(t.id===u){console.log(`Get ${u} from Unsplash collection successfully!`);a=true;const r=h(t["urls"][n]);await m(e,r);return r}}console.tag("Unsplash",a+" in page "+t);if(!a){if(t<i){console.warn(a+" in page "+t+"(repeat)");const r=await this.unsplash_new(e,t+1,n);await m(e,r);return r}else{const t=await d();await m(e,t);return t}}}catch(t){if(t.status==403){Toast.fire("部分图片受限无法加载",t.responseText,"warning");return null}const n=await d();await m(e,n);return n}function h(e){return f&&p?MUtils.update_URLParams(e,"w",p,"h",f,"fit","crop","crop","faces,entropy","auto","compress"):e}function d(){return new Promise(((e,t)=>{$.ajax({url:`https://api.unsplash.com/photos/${u}?client_id=HDbS2nAmPx8B4FKmzLYF3FEBUhbxXTtJcTyzdQCJr3M`,method:"GET",dataType:"json"}).done((t=>{const r=u?t["urls"][n]:t[Math.floor(Math.random()*11)]["urls"][n];e(h(r))})).fail((()=>{t("Error when calling Unsplash API.")}))}))}async function m(e,t){if(!window.caches){return}const n={timestamp:a,result:t};const r=new Response(JSON.stringify(n),{headers:{"Content-Type":"application/json"}});await o.put(e,r)}},e.random_pic=async function(e=""){return new Promise(((t,n)=>{$.ajax({url:`https://api.unsplash.com/photos/random?client_id=HDbS2nAmPx8B4FKmzLYF3FEBUhbxXTtJcTyzdQCJr3M&`+e,method:"GET",dataType:"json"}).done((e=>{let n=[e.urls.full,e.user.name,e.user.links.html+"?utm_source=lzc%27s%20blog&utm_medium=referral","https://unsplash.com/?utm_source=lzc%27s%20blog&utm_medium=referral"];t(n)})).fail((()=>{n("Error when calling Unsplash API.")}))}))},e.console_tag=function(e,t,n="gray",r="inherit"){const a=`border-radius: 5px; background-color:${n}; color:white;padding:1px 5px;margin-right: 5px;`;const s=`color:${r};`;console.log(`%c${e}%c${t}`,a,s)};e.safeParse=function(e){if(typeof e!=="string")return e;if(!isNaN(e)&&e.trim()!==""){return Number(e)}const t=e.toLowerCase();if(t==="true")return true;if(t==="false")return false;return e}})(window.MUtils=window.MUtils||{});