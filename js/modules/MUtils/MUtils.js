const MUtils={update_URLParams:function(e,...t){const n=new URLSearchParams(e.split("?")[1]||"");for(let e=0;e<t.length;e+=2){if(t[e+1]==="")n.delete(t[e]);else n.set(t[e],t[e+1])}return`${e.split("?")[0]}?${n.toString()}`},URLParam:function(e,t=null,n=window.location.href){let r=new URL(n);const s=new URLSearchParams(r.search);if(t===null){let t=s.get("clear");if(t){t.split(",").forEach((t=>{if(e==t&&s.get(t)){this.URLParam(t,"",n)}}))}let r=s.get(e);r=MUtils.safeParse(r);if(e=="password"){try{r=atob(r)}catch{console.warn("无法解码"+e)}}return r}else{let r=this.update_URLParams(n,e,t);if(n==window.location.href){window.history.replaceState({},"",r)}return r}},loadFile:function(e){return new Promise(((t,n)=>{const r=/\.(\w+)$/.exec(e);if(!r){n(new Error("Invalid file name"));return}const s=r[1];let a,o;if(s==="js"){a="script";o="src"}else if(s==="css"){a="link";o="href"}else{n(new Error("Unsupported file type"));return}const l=document.querySelectorAll(a);for(let n=0;n<l.length;n++){if(l[n].getAttribute(o)===e){t("File already loaded");return}}const i=document.createElement(a);if(s==="css"){i.rel="stylesheet";i.type="text/css"}else{i.type="text/javascript"}i[o]=e;i.onload=()=>t("File loaded successfully");i.onerror=()=>n(new Error("Error loading file"));document.head.appendChild(i)}))},loadScriptsSequentially:function(e){function t(n){if(n>=e.length)return;var r=document.createElement("script");r.src=e[n][0];r.defer=true;r.onload=function(){if(e[n][1]){e[n][1]()}t(n+1)};document.head.appendChild(r)}t(0)},unsplash_new:async function(e,t=1,n="regular"){console.tag("Unsplash","now searching page "+t);const r=7*24*60*60*1e3;const s=(new Date).getTime();const a="unsplash-cache";const o=await caches.open(a);const l=await o.match(e);if(l){const t=await l.json();console.tag("Unsplash",`Cache for ${e} found.`);if(s-t.timestamp<r){return t.result}}const i=4;const c=e.match(/https:\/\/source.unsplash.com\/([-\w]+)?\/?(\d+)?x?(\d+)?/);if(!c){throw new Error("Invalid URL format.")}let[u,p,f,h]=c;if(!p){p="";console.warn(p);const t=await m();await w(e,t);return t}try{console.tag("Unsplash",t+"finding_page");const r=await $.ajax({url:`https://api.unsplash.com/collections/CBPlaRQlVQo/photos/?client_id=HDbS2nAmPx8B4FKmzLYF3FEBUhbxXTtJcTyzdQCJr3M&per_page=30&page=${t}`,method:"GET",dataType:"json"});let s=false;for(let t of r){if(t.id===p){console.log(`Get ${p} from Unsplash collection successfully!`);s=true;const r=d(t["urls"][n]);await w(e,r);return r}}console.tag("Unsplash",s+" in page "+t);if(!s){if(t<i){console.warn(s+" in page "+t+"(repeat)");const r=await this.unsplash_new(e,t+1,n);await w(e,r);return r}else{const t=await m();await w(e,t);return t}}}catch(t){if(t.status==403){Toast.fire("部分图片受限无法加载",t.responseText,"warning");return null}const n=await m();await w(e,n);return n}function d(e){return h&&f?MUtils.update_URLParams(e,"w",f,"h",h,"fit","crop","crop","faces,entropy","auto","compress"):e}function m(){return new Promise(((e,t)=>{$.ajax({url:`https://api.unsplash.com/photos/${p}?client_id=HDbS2nAmPx8B4FKmzLYF3FEBUhbxXTtJcTyzdQCJr3M`,method:"GET",dataType:"json"}).done((t=>{const r=p?t["urls"][n]:t[Math.floor(Math.random()*11)]["urls"][n];e(d(r))})).fail((()=>{t("Error when calling Unsplash API.")}))}))}async function w(e,t){const n={timestamp:s,result:t};const r=new Response(JSON.stringify(n),{headers:{"Content-Type":"application/json"}});await o.put(e,r)}},random_pic:async function(e=""){return new Promise(((t,n)=>{$.ajax({url:`https://api.unsplash.com/photos/random?client_id=HDbS2nAmPx8B4FKmzLYF3FEBUhbxXTtJcTyzdQCJr3M&`+e,method:"GET",dataType:"json"}).done((e=>{let n=[e.urls.full,e.user.name,e.user.links.html+"?utm_source=lzc%27s%20blog&utm_medium=referral","https://unsplash.com/?utm_source=lzc%27s%20blog&utm_medium=referral"];t(n)})).fail((()=>{n("Error when calling Unsplash API.")}))}))},console_tag:function(e,t,n="gray",r="inherit"){const s=`border-radius: 5px; background-color:${n}; color:white;padding:1px 5px;margin-right: 5px;`;const a=`color:${r};`;console.log(`%c${e}%c${t}`,s,a)},safeParse:function(e){if(typeof e!=="string")return e;if(!isNaN(e)&&e.trim()!==""){return Number(e)}const t=e.toLowerCase();if(t==="true")return true;if(t==="false")return false;return e}};export default MUtils;window.MUtils=MUtils;