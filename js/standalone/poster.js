FingerprintJS.load().then((function(e){return e.get()})).then((e=>fgp=e.visitorId));var settings={};window.addEventListener("load",(function(){$(".collapsible").collapsible();M.Tabs.init(document.querySelector(".tabs"),{onShow:function(){if(this.index==1){M.textareaAutoResize($(`#content_edit`));M.textareaAutoResize($(`#foot_edit`))}}});$("select").formSelect();$(".pic-eg").on("click",(function(){let e=$(this).css("background-image");fchange.pic(e)}));if(/firefox/gi.test(navigator.userAgent)){fchange.cssvar("font-family","revert")}if(MUtils.URLParam("mode")&&MUtils.URLParam("mode").indexOf("app")>-1)document.querySelectorAll(".gpt").forEach((e=>e.remove()));if(MUtils.URLParam("mode")&&MUtils.URLParam("mode")=="quickapp"){UIHelper.menu();document.getElementById("menu").remove()}const e=(e,t)=>{let n;return function o(...s){const i=()=>{clearTimeout(n);e(...s)};clearTimeout(n);n=setTimeout(i,t)}};if("windowControlsOverlay"in navigator){t();navigator.windowControlsOverlay.addEventListener("geometrychange",e((e=>{t()}),200));function t(){const e=navigator.windowControlsOverlay.visible;if(e){document.querySelectorAll("header,#menu").forEach((e=>{e.classList.add("isOverlayVisible")}))}else{document.querySelectorAll("header,#menu").forEach((e=>{e.classList.remove("isOverlayVisible")}))}}}fsettings.load();let n=document.querySelector("#loading-waring .font-loading");document.fonts.onloadingdone=function(e){if(e.fontfaces.length>9){Toast.fire("",e.fontfaces.length+"种字体加载完成","success")}n.style.height="0";M.textareaAutoResize($(`#content_edit`));M.textareaAutoResize($(`#foot_edit`));console.log(`document.fonts.onloadingdone触发`)};document.fonts.ready.then((function(){n.style.height="0";M.textareaAutoResize($(`#content_edit`));M.textareaAutoResize($(`#foot_edit`));console.log(`document.fonts.ready.then触发`)}))}));function random_keyword(e){let t="";$.get(`https://pixabay.com/api/?key=6295509-b67e3d655066dca3360851316&per_page=10&q=${e}`,(function(n,o){for(i=0;i<9;i++){try{t+=`<div class="pic-eg" style="background-image:url('${n.hits[i].webformatURL}')"></div>`}catch(n){console.error(n);t+=`<div class="pic-eg" style="background-image:url('https://source.unsplash.com/80${i}x0/?${e}')"></div>`}}$("#pic_search_res").html(t);$(".pic-eg").on("click",(function(){const e=$(this).css("background-image");fchange.pic(e)}))}))}const UIHelper={select_edit:function(e,t){let n=Array.prototype.slice.call(e.options).find((e=>e.value==t));n.selected=true;e.parentNode.children[0].value=n.text;e.parentNode.children[0].setAttribute("style",n.getAttribute("style"));return{id:e.id,value:t}},check2val:function(e){const t=e.checked?0:1;const n=e.dataset.tf.split("|")[t];return n},menu:function(e=document.getElementById("menu")){let t=e.firstChild.firstChild.style;if(t.transform==""){t.transform="rotate(180deg)";document.querySelector(":root").style.setProperty("--header-height","env(titlebar-area-height,45px)")}else{t.transform="";document.querySelector(":root").style.setProperty("--header-height","0")}},pic_source_type:function(e){if(e==5){UIHelper.ask_permission("pic").catch((e=>{console.error(e);UIHelper.pic_source_type(1);return}))}UIHelper.select_edit(document.getElementById("bgpic-select"),e);$("[id*=pic_source_type]").hide();$(`#pic_source_type${e}`).show();if(e<=1)$("#tab3li").hide();else $("#tab3li").show();$(".tabs").tabs("updateTabIndicator")},pic_upload:function(e){var t=new FileReader;t.readAsDataURL(e.files[0]);t.onload=function(){fchange.pic(`url(${this.result})`)}},ask_permission:async function(e){if(!MUtils.URLParam("mode")||MUtils.URLParam("mode").indexOf("app")==-1){return Promise.resolve("无需申请权限")}let t,n;switch(e){case"pic":t="为了读取您上传的图片，应用需要<b>读取照片</b>权限。";n="只能读取您在下一页面选择的照片。照片将在本地处理，不会上传到服务器。";break;case"file":t="为了读取您上传的文件，应用需要<b>读取文件</b>权限。";n="只能读取您在下一页面选择的文件。文件将在本地处理，不会上传到服务器。";break;case"share":t="授权后，当前成品图将上传服务器。被精选后，将与所有用户<b>分享</b>。";n="上传后将无法删除。请谨慎操作。";break;default:return Promise.resolve("未知权限名")}return Swal.fire({icon:"question",title:"权限申请",html:t,footer:n,allowOutsideClick:false,confirmButtonText:"授权本次",showDenyButton:true,denyButtonText:`拒绝`,denyButtonColor:"var(--lighttextcolor)"}).then((t=>{if(t.isDenied){return Promise.reject("用户拒绝了"+e+"权限申请")}else{return Promise.resolve("用户给予权限")}}))}};const fchange={text:function(e,t="content",n=false){let o="";try{o=futils.md2html(e)}catch(t){o=`<p>${e}</p>`;o=o.replace(/\n/g,"</p><p>");console.log("md解析失败"+t)}$(`#${t}`).html(o);fsettings.save("text",`${t}`,e);if(n){document.getElementById(`${t}_edit`).value=e;M.updateTextFields()}},cssvar:function(){const e={"border-style":function(e){if(e=="none"){document.querySelectorAll(".border-style-opt").forEach((e=>e.style.display="none"));document.querySelector("#text").classList.add("border-style-none")}else{document.querySelectorAll(".border-style-opt").forEach((e=>e.style.display="flex"));document.querySelector("#text").classList.remove("border-style-none")}},"font-family":function(e){M.textareaAutoResize($(`#content_edit`));M.textareaAutoResize($(`#foot_edit`));if(e!="revert"&&!document.fonts.check(`12px ${e}`)){let t=document.querySelector("#loading-waring .font-loading");t.dataset.font_family=e;t.style.height="15px";console.log(`${e}字体尚未加载完成，请稍等`)}}};for(let t=0;t<arguments.length;t=t+2){let n=arguments[t],o=arguments[t+1];try{document.querySelector("body").style.setProperty(`--${n}`,o)}catch(e){console.error(`更改id为${arguments[t]}的控制元素失败：${e}`)}try{let e=document.getElementById(n);if(e.tagName.toLocaleLowerCase()=="input"){if(e.type=="checkbox"){let t=e.dataset.tf.split("|")[0];if(o==t)e.checked=true;else e.checked=false;fsettings.save("cssvar",e.id,o)}else{e.value=o.indexOf("#")>-1?o:parseFloat(o);fsettings.save("cssvar",e.id,o);let t=e.previousElementSibling;if(t.className.indexOf("switch-res")>-1)t.innerHTML=parseFloat(o)}}else if(e.tagName.toLocaleLowerCase()=="select"){UIHelper.select_edit(e,o);fsettings.save("cssvar",e.id,o)}else throw`id为${n}的显示元素类型不受支持`}catch(e){console.error(`更改id为${arguments[t]}的显示值失败：${e}`)}if(e[n])e[n](o)}return},layout:function(func_name,param){fsettings.save("layout",func_name,param);eval(`${func_name}(${param})`);return;function sentence_type(e){document.querySelectorAll(".letter_opt, .quote_opt").forEach((e=>e.style.display="none"));let t={};let n={};switch(e){case"quote":$(".quote_opt").show();$("#text").removeClass("letter");t={"text-color":"#4d4135"};n={"text-align":"center","text-indent":"0em","text-padding1":"6.5em","text-padding2":"3.5em"};break;case"notice":$(".letter_opt").show();$("#text").addClass("notice");t={"font-family":"方正仿宋","title-font-family":"方正小标宋","text-color":"#4d4135","border-style":"solid","border-color":"#dfd6c5"};n={"text-align":"justify","text-indent":"2em","text-padding1":"2.5em","text-padding2":"0.9em"};break;case"letter":$(".letter_opt").show();$("#text").addClass("letter");t={"font-family":"方正仿宋","title-font-family":"方正小标宋","text-color":"#4d4135","border-style":"solid","border-color":"#dfd6c5"};n={"text-align":"justify","text-indent":"2em","text-padding1":"2.5em","text-padding2":"0.9em"};fchange.pic("linear-gradient(rgb(249, 233, 220), rgb(249, 233, 220))");break}Object.keys(n).forEach((function(e){fchange.cssvar(e,n[e])}));let o=localStorage.getItem("settings");o=o?JSON.parse(o):{};o=o["cssvar"]?o["cssvar"]:{};o=Object.keys(o);Object.keys(t).forEach((function(e){if(o.indexOf(e)==-1){fchange.cssvar(e,t[e])}}));UIHelper.select_edit(document.getElementById("sentence_type"),e)}function letter_begin(e,t){document.getElementById("letter1").checked=e;document.getElementById("letter2").checked=t;e=e?"1":"0";t=t?"1":"0";$("#text").attr("data-letter-b",e+t)}function letter_end(e,t){document.getElementById("letter3").checked=e;document.getElementById("letter4").checked=t;e=e?1:0;t=t?1:0;$("#text").attr("data-letter-e",e+t)}function aspectRatio(e){e=e.replace(/[\:：]/g,"/");document.getElementById("aspectRatio").value=e;if(e&&CSS.supports("aspect-ratio:"+e)){document.querySelector("body").style.setProperty(`--aspectRatio`,e);document.querySelector("body").classList.add("aspectRatio")}else{document.querySelector("body").style.removeProperty(`--aspectRatio`);document.querySelector("body").classList.remove("aspectRatio")}}},pic:async function(e,t=true){const n=document.getElementById("pic");let o=s(e);if(o){document.querySelector("#loading-waring .pic-loading").style.height="15px";let t=await futils.get_base64(o);if(!t)t=o;e=`url("${t}")`;n.src=t}else{document.querySelector("#loading-waring .pic-loading").style.height="0px";n.src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7"}$("#result,#toppic").css("background-image",e);if(t){n.crossOrigin="anonymous";$(".open_in_newtab").hide();document.getElementById("upload-btn").classList.remove("disabled")}else{n.removeAttribute("crossorigin");Swal.fire({icon:"warning",title:"请手动截图",html:"若使用该图作为背景图，请手动对海报截图。点击 “预览/下载图片” 按钮将导出失败。",footer:"这是由于，图片提供者设置了跨域政策。这可能是出于版权保护或服务器保护的目的。"});$(".open_in_newtab").show();document.getElementById("upload-btn").classList.add("disabled")}function s(e){var t=e;var n=/url\((.*)\)/;var o="";try{o=n.exec(t)[1].trim();o=o.replace(/["']/g,"")}catch(e){o=false}return o}fsettings.save("pic","css_v",e);fsettings.save("pic","crossOrigin",t);return}};const fsettings={new:function(){fsettings.save2list().finally((e=>{console.info(e);localStorage.setItem("settings","");location.reload()}))},save:function(e,t,n){settings[e]=settings[e]?settings[e]:{};settings[e][t]=n;localStorage.setItem("settings",JSON.stringify(settings));return},load:function(e=localStorage.getItem("settings"),t=false){if(t)e=decodeURI(e);if(e){localStorage.setItem("settings",e);const t=JSON.parse(e);Object.freeze(t);settings=JSON.parse(JSON.stringify(t));if(t["layout"]){for(k in t["layout"]){fchange.layout(k,t["layout"][k])}}t["pic"]&&fchange.pic(t["pic"]["css_v"],t["pic"]["crossOrigin"]);if(t["text"]){for(k in t["text"]){fchange.text(t["text"][k],k,true)}}if(t["cssvar"]){for(let e in t["cssvar"]){fchange.cssvar(e,t["cssvar"][e])}}return true}else{return false}},download:function(e=localStorage.getItem("settings"),t=false){if(t)e=decodeURI(e);futils.saveTextAsFile(e,`${futils.get_download_file_name()}.settings.json`,"application/json")},upload_handle:function(){UIHelper.ask_permission("file").then((()=>{const e=document.getElementById("settings_upload");e.value="";e.click();e.addEventListener("change",(()=>{let t=e.files[0];if(t.name.endsWith(".settings.json")){fsettings.upload(t);fsettings.read_from_list()}else if(t.name.endsWith(".all.json")){fsettings.import_all_list(t)}else{Swal.fire("文件必须是<code>.settings.json</code>或<code>.all.json</code>格式","","error")}}))}))},upload:function(e){let t=new FileReader;t.readAsText(e);t.onload=function(){fsettings.load(this.result);Swal.fire({imageUrl:"/medias/loading/hourglass.svg",title:"成功读取",html:"正在加载设置文件，请稍后..."});let e=JSON.parse(this.result);let t;try{t=futils.get_download_file_name()}catch(e){t="上传的设置"}fsettings.save2list(this.result,t);location.reload()}},clear:function(){for(let e in arguments){try{if(arguments[e]=="filter"){const e={"filter-bright":"1","filter-blur":"0","filter-gray":"0","filter-contrast":"1","filter-invert":"0","filter-saturate":"1","filter-sepia":"0"};Object.keys(e).forEach((t=>fchange.cssvar(t,e[t])))}else delete settings[arguments[e]]}catch(t){console.warn("无法删除"+arguments[e]+"\n"+t)}}localStorage.setItem("settings",JSON.stringify(settings));location.reload()},save2list:function(e=localStorage.getItem("settings"),t=null){return new Promise((async function(n,o){let s=localStorage.getItem("settings_list");s=s?JSON.parse(s):{};let i=false;if(!t){let t=futils.get_download_file_name();const{value:n}=await Swal.fire({title:`<i class="fa-regular fa-floppy-disk"></i> 保存当前海报`,input:"text",inputLabel:"请输入当前海报标题",inputValue:t,showCancelButton:true,confirmButtonText:i?"仍要覆盖":"保存到列表",cancelButtonText:"不保存",inputValidator:e=>{if(!e){return"请输入海报标题"}if(!i&&Object.keys(s).includes(e)){i=true;document.querySelector("button.swal2-confirm").innerText="仍要覆盖";document.querySelector("#swal2-title").innerText="是否覆盖？";return"<span>名为『<b>"+e+"</b>』的海报已存在，仍要覆盖吗？</span>"}}});if(n){fsettings.save("info","title",n);r(e,n)}else{o("保存失败")}}else r(e,t);n(t);function r(e,t){s[t]=e;localStorage.setItem("settings_list",JSON.stringify(s));Swal.fire({icon:"success",title:"保存成功",timer:3e3})}}))},validate_list:function(e=true){let t=localStorage.getItem("settings_list");if(!t){if(!e){Swal.fire({icon:"warning",title:"没有保存的海报",timer:3e3})}return false}else{t=JSON.parse(t);return t}},read_from_list:function(){let e=fsettings.validate_list();if(!e)e={};let t="<div>保存和上传的文件，将在此处显示。<br>注：以下文件的后缀名为:<code>.settings.json</code></div><br><div class='settings_list_table'>";for(let n in Object.keys(e)){t+="<div class='settings_name'>"+Object.keys(e)[n]+"</div>";t+=`<div class="btn settings_button" style="padding: 0 24px;" onclick="fsettings.load('${encodeURI(Object.values(e)[n])}',true);fsettings.save('info','title','${Object.keys(e)[n]}');Swal.close()">  <i class="fa-solid fa-check"></i>  </div>`;t+=`<div class="btn blank settings_button" style="transform: scale(0.9);" onclick="fsettings.download('${encodeURI(Object.values(e)[n])}',true);Swal.close()"><i class="fa-solid fa-download"></i></div>`;t+=`<div class="btn blank settings_button" style="transform: scale(0.9);" onclick="fsettings.delete_from_list('${Object.keys(e)[n]}')"><i class="fa-solid fa-trash"></i></div>`}t+="</div>";if(Object.entries(e).length>0){t+='<div class="btn blank settings_button" onclick="fsettings.export_all_list()">批量下载</div>'}t+='<div class="btn blank settings_button" onclick="fsettings.upload_handle()">批量上传</div>';Swal.fire({title:"海报列表",html:t,showCloseButton:true,showConfirmButton:false})},delete_from_list:function(e){let t=fsettings.validate_list();if(!t)return false;delete t[e];localStorage.setItem("settings_list",JSON.stringify(t));fsettings.read_from_list()},export_all_list:function(){let e=fsettings.validate_list();if(!e)return false;futils.saveTextAsFile(JSON.stringify(e),`所有海报设置.all.json`,"application/json")},import_all_list:async function(e){let t=new FileReader;t.readAsText(e);t.onload=function(){let e=this.result;try{e=JSON.parse(this.result);let t=fsettings.validate_list()?fsettings.validate_list():{};for(let n in e){if(Object.keys(t).includes(n)){console.warn("skip "+n);continue}t[n]=e[n]}localStorage.setItem("settings_list",JSON.stringify(t));fsettings.read_from_list();dom.value="";return new Promise((e=>e("success")))}catch(e){fsettings.swal_json_error();return new Promise((t=>t(e)))}}},swal_json_error:function(){}};const futils={saveTextAsFile:function(e,t,n){if(e){let o=new Blob([e],{type:n});let s=document.createElement("a");s.download=t;s.innerHTML="Download File";s.href=window.URL.createObjectURL(o);s.style.display="none";document.body.appendChild(s);s.click();delete s;Swal.fire({icon:"success",title:"即将弹出下载窗口",timer:3e3});return true}else{Swal.fire({icon:"error",title:"下载文件为空",timer:3e3});return false}},md2html:function(e){e=e.replace(/\n(?=\n\n)/g,"\n\n<br/>\n");let t=marked.parse(e,{breaks:true});return t},get_download_file_name:function(e=null){if(e===null){if(settings.info&&settings.info.title)e=settings.info.title;else if(settings.text&&settings.text.content)e=settings.text.content;else e="没有正文的海报"}let t=e.match(/(\S+?)(,|，|\s|\n|\.|。)/);t=t?t[1]:e;return t},get_base64:function(e){return new Promise((function(t,n){window.URL=window.URL||window.webkitURL;var o=new XMLHttpRequest;o.open("get",e,true);o.responseType="blob";o.onload=function(){if(this.status==200){var s=this.response;let e=new FileReader;e.readAsDataURL(s);e.onloadend=function(e){let n=e.target.result;document.querySelector("#loading-waring .pic-loading").style.height="0px";t(n)}}else if(this.status==301||this.status==302){console.log(e+"重定向至："+o.responseURL);get_base64(o.responseURL)}else{n("无法打开图片链接！图片链接有误，或可能已过期。")}};o.send()}))},isURL:function(e){var t="^((https|http|ftp|rtsp|mms)?://)"+"?(([0-9a-z_!~*'().&=+$%-]+: )?[0-9a-z_!~*'().&=+$%-]+@)?"+"(([0-9]{1,3}.){3}[0-9]{1,3}"+"|"+"([0-9a-z_!~*'()-]+.)*"+"([0-9a-z][0-9a-z-]{0,61})?[0-9a-z]."+"[a-z]{2,6})"+"(:[0-9]{1,4})?"+"((/?)|"+"(/[0-9a-z_!~*'().;?:@&=+$,%#-]+)+/?)$";var n=new RegExp(t);return n.test(e)}};function capture(e=0){if(!document.getElementById("pic").complete){Swal.fire({icon:"error",title:"背景图片尚未加载完成",html:"请等待背景图片加载完成，或更换背景为渐变填充。",showConfirmButton:true});return false}$("#filter,#result").css("border-radius",0);if(e==4){let e=window.open("");e.document.write(`<html><head><title>对本页面截图</title><link rel="stylesheet" href="/css/standalone/poster-result.css" type="text/css"/><style>body{width: 100vw;}#result{transform:translateZ(0) scale(2);transform-origin: 0 0 0}</style></head><body><p style="font-size: 3vmax;margin-bottom: 3vh;">您可以滚动截图</p>${document.getElementById("result").outerHTML.replace(/contenteditable="true"/g,"")}</body></html>`);e.focus();$("#filter,#result").css("border-radius","5px");return true}Swal.fire({imageUrl:"/medias/loading/hourglass.svg",imageWidth:100,imageHeight:100,imageAlt:"loading",title:"请稍后",html:"图片生成中，预计需要10秒<br>网页可能暂时无响应，请稍安勿躁",showConfirmButton:false,timer:3e4,timerProgressBar:true,allowOutsideClick:false}).then((e=>{if(e.dismiss===Swal.DismissReason.timer){Swal.fire("请再试一次","超时","error")}}));var t=document.getElementById("result");var n={scale:e==2?1:5,only_style:"/css/standalone/poster-result.css"};domtoimage.toJpeg(t,n).then((function(t){let n=new Image;n.src=t;let r=/firefox/gi.test(navigator.userAgent)?`<div class="firefox swal2-icon swal2-warning swal2-icon-show" style="display: flex;"><div class="swal2-icon-content">!</div></div><div class="firefox"><svg xmlns:xlink="http://www.w3.org/1999/xlink" xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 100 100" version="1.1"><ellipse cx="50" cy="50" rx="24" ry="24" fill="#80e"></ellipse><path d="M50 42c-14-7-11-8-16-11-1-4-1-8 0-12-5 2-9 5-12 9-1-4-1.4-7-1-12C8 24 2 38 2 50c-0 31 26 49 48 49 22 0 48-16 48-49 0-5 0-9-3-16-9 21-23 40-45 40-8 0-23-4-23-25 7-2 16-3 23-7z" fill="#f73"></path><path d="M50 42c-17 6-20-8-35 0 3 6 7 7 11 7 0 20 12 26 24 26 19 0 37-9 45-41-7-17-23-19-29-34-9 6-15 14-16 26 12 0 24 10 24 24 0 15-14 23-24 23-5 0-19-2-21-17 2-6 8-8 16-9 3-1 4-3 5-5z" fill="#fc3"></path></svg> Firefox火狐浏览器可能<b class="text-color">不支持使用自定义字体和网络图片</b>。<br>如遇错误，请直接截图或使用Chrome或Edge浏览器。</div>`:false;switch(e){case 1:Swal.fire({html:`<img src="${t}" alt="生成图片" style="max-width:100%">`,footer:r,allowOutsideClick:false,showCloseButton:true,showConfirmButton:true,confirmButtonText:'<i class="fa-solid fa-file-export"></i> 导出',showCancelButton:true,cancelButtonText:"取消",showDenyButton:r?true:false,denyButtonText:"使用Edge浏览器打开",focusDeny:r?true:false,denyButtonColor:"#e64a19",customClass:{denyButton:"firefox"},preConfirm:()=>{if(window.navigator.userAgent.toLowerCase().match(/MicroMessenger/i)=="micromessenger"){alert("请长按图片保存")}else{o(futils.get_download_file_name(),t);Swal.close()}return false},preDeny:()=>{window.open("microsoft-edge:https://lzc2002.top/tools/tools-pc.html?src=/tools/poster/index.html");return false}});break;case 2:s(t);break;case 3:i(t);break;default:o(futils.get_download_file_name(),t);break}$("#filter,#result").css("border-radius","5px")})).catch((function(e){console.warn(e);const t=/firefox/gi.test(navigator.userAgent)?`<div class="firefox swal2-icon swal2-warning swal2-icon-show" style="display: flex;"><div class="swal2-icon-content">!</div></div><div class="firefox"> 如在Firefox火狐浏览器内遇到错误，请尝试更换至Edge或Chrome浏览器。</div>`:false;Swal.fire({icon:"error",title:"请再试一次",html:"若错误持续出现，请更换背景图片。",footer:"错误信息："+e.toString(),showDenyButton:t?true:false,denyButtonText:"使用Edge浏览器打开",focusDeny:t?true:false,denyButtonColor:"#e64a19",preDeny:()=>{window.open("microsoft-edge:https://lzc2002.top/tools/tools-pc.html?src=/tools/poster/index.html");return false}})}));function o(e,t){var n=document.createElement("a");n.href=t;n.download=e;let o=document.createEvent("MouseEvents");o.initMouseEvent("click",true,false,window,0,0,0,0,0,false,false,false,false,0,null);n.dispatchEvent(o);Swal.fire({icon:"success",title:"即将弹出下载窗口",timer:3e3})}function s(e){UIHelper.ask_permission("share").then((async()=>{AV.init({appId:"KKXPJIC2tKhiht5uCdmFR6R0-gzGzoHsz",appKey:"3C6HL2hRYTdga856HYn4V1Sw",serverURL:"https://leancloudcn.lzc2002.top",serverURLs:"https://leancloudcn.lzc2002.top"});const t=AV.Object.extend("Poster");const n=new t;const o=document.getElementById("content").innerText;const s=document.getElementById("foot").innerText;const[i,r]=await MInfo.iploc_;n.set("content",o);n.set("foot",s);n.set("dataurl",e);n.set("ip",i);n.set("iploc",r);n.save().then((e=>{console.log(`保存成功。objectId: ${e.id}`);Swal.fire({icon:"success",title:"上传成功",html:`存档编号: ${e.id}`,confirmButtonText:"去看看",showCancelButton:true,cancelButtonText:"好的"}).then((e=>{if(e.value)window.open("/tools/poster/result.html")}))}),(e=>{console.error("leancloud error:"+e);Swal.fire({icon:"error",title:"上传失败",confirmButtonText:"好的"})}))}))}async function i(e){try{const t=await fetch(e);const n=await t.blob();await navigator.clipboard.write([new ClipboardItem({[n.type]:n})]).then((()=>{Toast.fire({icon:"success",title:"复制成功"})}),(e=>{const t=e.toString().indexOf("Write permission denied")>-1?true:false;Swal.fire({title:t?"请允许剪切板权限":"复制失败",html:t?"剪切板访问被拒绝":"请直接下载图片",icon:"error",footer:e});console.error(e)}))}catch(e){Swal.fire({icon:"error",title:"复制失败",footer:e})}}}const frandom={random_quote:function(){fchange.layout("sentence_type",`"quote"`);fchange.cssvar("text-color","#ffffff","border-style","none");const e={a:"japanese cartoon",b:"comic",c:"video game",d:"literature",e:"original",f:"blur",g:"wallpaper",h:"film",i:"中国风",j:"cloud",k:"philosophy",l:"snarky"};$.get("https://v1.hitokoto.cn/?time="+(new Date).getTime(),(function(t,n){Swal.fire({icon:"question",title:"确认使用？",html:`<span style="color:var(--lighttextcolor)">${t.from_who?t.from_who:t.creator}《${t.from}》</span>：『<span style="font-weight:bold">${t.hitokoto}</span>』`,showDenyButton:true,showCancelButton:true,confirmButtonText:"确认",denyButtonText:`换一句`,cancelButtonText:`取消`}).then((n=>{if(n.isConfirmed){fchange.text(t.hitokoto,"content",true);fchange.text(`${t.from_who?t.from_who:t.creator}《${t.from}》`,"foot",true);fchange.cssvar("filter-bright","0.4");let n="",o=100;$.get(`https://pixabay.com/api/?key=6295509-b67e3d655066dca3360851316&per_page=${o}&q=${e[t.type]}`,(function(s,i){try{let e=Math.floor(Math.random()*o);n=s.hits[e].webformatURL}catch(o){console.error(o);n="https://source.unsplash.com/800x0/?"+e[t.type]+"&"+(new Date).getTime()}fchange.pic(`url(${n})`)}));return}else if(n.isDenied){frandom.random_quote()}}))}))},random_gpt:async function(){frandom.ask_gpt().then((e=>{const t=e[0];const n=e[1];if(document.getElementById("gpt_res").innerHTML)document.getElementById("gpt_res").innerHTML="<p>生成中...上一次的结果：</p>"+document.getElementById("gpt_res").innerHTML;frandom.swal_rendering();const o={url:"https://api.openai.com/v1/completions",method:"POST",timeout:0,headers:{Authorization:"Bearer "+t,"Content-Type":"application/json"},data:JSON.stringify({model:"text-davinci-003",prompt:`请围绕这句话进行文学创作（字数在150字以内）：${n}\n请不要在回答中复述这句话。`,max_tokens:1024,temperature:1,user:fgp})};$.ajax(o).done((function(e){let t=e.choices[0].text.trim().replace(/\n{2,}/g,"\n");t="<p>"+t.replace(/\n/g,"</p><p>")+"</p>";document.getElementById("gpt_res").innerHTML="<p>“"+n+"”</p>"+t;Swal.fire({title:"成功",icon:"success",html:"生成卡片？",confirmButtonText:"生成",cancelButtonText:"取消",showCancelButton:true}).then((e=>{if(e.value){fchange.layout("sentence_type",'"letter"');fchange.text(t,"content");fchange.layout("letter_begin",[0,0]);fchange.layout("letter_end",[0,0]);document.querySelectorAll("[id*=letter]").forEach((e=>e.checked=false));fchange.cssvar("text-padding1","0.8em")}}))})).fail((function(e){console.error(e);Swal.fire({title:"获取失败",icon:"error",footer:e.responseJSON.error.type=="invalid_request_error"?"API错误":"未知错误"})}))}))},random_gpt_pic:async function(){frandom.ask_gpt().then((e=>{const t=e[1];const n=e[0];const o=new Headers;o.append("Authorization",`Bearer ${n}`);o.append("Content-Type","application/json");const s=JSON.stringify({prompt:t,size:"512x512",user:fgp});const i={method:"POST",headers:o,body:s,redirect:"follow"};frandom.swal_rendering();return i})).then((requestOptions=>fetch("https://api.openai.com/v1/images/generations",requestOptions).then((e=>e.text())).then((result=>{try{result=eval("("+result+")");if(result.error)throw new Error(result.error.message,{message:result.error.code,cause:result.error.type});const url=result.data[0].url;const html=`<div class="pic-eg gptpic" style="background-image:url('${url}')"></div>`;document.getElementById("pic_gpt_res").innerHTML+=html;fchange.pic(`background-image:url('${url}')`,false);$(".pic-eg.gptpic").on("click",(function(){const e=$(this).css("background-image");fchange.pic(e,false)}));fchange.cssvar("filter-bright","0.5");document.getElementById("pic").onload="Toast.fire({title:'成功',icon:'success'});this.onload=null"}catch(e){console.error(e);Swal.fire({title:"添加图片失败",footer:e,icon:"error"})}})).catch((e=>{Swal.fire({title:"生成失败",footer:e.toString().replace(/Failed to fetch/g,"无法连接到ChatGPT"),icon:"error"});console.error(e)}))))},ask_gpt:async function(){const e=document.getElementById("content").innerText;const t=localStorage.getItem("gpt_key");const{value:[n,o]}=await Swal.fire({title:"Chat GPT API调用",html:` \n        <form class="col s12 row" style="margin-bottom: 0;">\n          \n            <div class="input-field col s12">\n              <input id="gpt-input1" type="text" value=${t?t:""}>\n              <label for="gpt-input1">API密钥</label>\n            </div>\n            <div class="input-field col s12" style="margin-bottom: 0">\n              <input id="gpt-input2" type="text" value="${e}">\n              <label for="gpt-input2">围绕主题</label>\n            </div>\n        </form><style onload="M.updateTextFields()"></style>\n        `,footer:`<a href="https://platform.openai.com/account/api-keys">获取API密钥</a>`,focusConfirm:false,showCancelButton:true,preConfirm:()=>[document.getElementById("gpt-input1").value,document.getElementById("gpt-input2").value],customClass:{htmlContainer:"row"}});localStorage.setItem("gpt_key",n);const s=new Promise((function(e,t){if(n&&o)e([n,o]);else t()}));return s},swal_rendering:function(){Swal.fire({title:"正在连接Chat GPT",html:"可关闭对话框，但不要关闭网页",imageUrl:"/medias/loading/hourglass.svg",imageWidth:100,imageHeight:100,imageAlt:"loading",showConfirmButton:false,showCloseButton:!0})}};function drag(e){var t=document.getElementById("left");var n=t.offsetHeight;var o=e.touches[0].clientY;document.ontouchmove=function(e){var s=e.touches[0].clientY-o;t.style.height=n+s+"px";const i=window.innerHeight-document.querySelector("#left-right-hr").offsetHeight-document.querySelector("header").offsetHeight;if(t.offsetHeight>i-20)t.style.height=i+"px"};document.ontouchend=function(){document.ontouchmove=null}}window.addEventListener("error",(e=>{console.error(e)}),true);window.addEventListener("unhandledrejection",(function(e){console.error(JSON.stringify(e.reason));let t=JSON.stringify(e.reason).toString();if(t.indexOf("exceeded the quota")>-1)t="上传的图片大于4.9MB！您仍可正常导出海报图片，但是无法保存配置信息。";Swal.fire({icon:"error",title:t.toString(),text:"程序错误",footer:"请检查输入或上传的文件是否正确，并确保网络畅通。",showConfirmButton:false,showCloseButton:true})}),true);window.addEventListener("keydown",(function(e){if((navigator.platform.match("Mac")?e.metaKey:e.ctrlKey)&&document.activeElement.tagName.toLowerCase()!="textarea"){switch(e.key.toLowerCase()){case"s":e.preventDefault();fsettings.save2list();break;case"c":e.preventDefault();capture(3);break;case"o":e.preventDefault();fsettings.read_from_list();break;case"p":e.preventDefault();capture(1);break;case"e":e.preventDefault();capture();break}}}),false);