FingerprintJS.load().then((function(e){return e.get()})).then((e=>fgp=e.visitorId));window.addEventListener("load",(function(){$(".collapsible").collapsible();$("select").formSelect();$(".pic-eg").on("click",(function(){let e=$(this).css("background-image");pic_change(e)}));let e=localStorage.getItem("text-content");if(e){document.getElementById("content_edit").value=e;document.getElementById("content").innerHTML=md2html(e);M.textareaAutoResize($("#content_edit"))}e=localStorage.getItem("text-foot");if(e){document.getElementById("foot_edit").value=e;document.getElementById("foot").innerHTML=e;M.textareaAutoResize($("#foot_edit"))}if(/firefox/gi.test(navigator.userAgent)){cssvar_change("font-family","revert")}const t=(e,t)=>{let n;return function o(...r){const i=()=>{clearTimeout(n);e(...r)};clearTimeout(n);n=setTimeout(i,t)}};if("windowControlsOverlay"in navigator){n();navigator.windowControlsOverlay.addEventListener("geometrychange",t((e=>{n()}),200));function n(){const e=navigator.windowControlsOverlay.visible;if(e){document.querySelectorAll("header,#menu").forEach((e=>{e.classList.add("isOverlayVisible")}))}else{document.querySelectorAll("header,#menu").forEach((e=>{e.classList.remove("isOverlayVisible")}))}}}let o=localStorage.getItem("settings");if(o){o=JSON.parse(o)}if(o["cssvar_change"]){for(let r in o["cssvar_change"]){cssvar_change(r,o["cssvar_change"][r])}}if(o["layout_change"]){for(k in o["layout_change"]){layout_change(k,o["layout_change"][k])}}o["pic_change"]&&pic_change(o["pic_change"][0],o["pic_change"][1]);M.updateTextFields()}));function pic_change(e,t=true){$("#result,#toppic").css("background-image",e);const n=document.getElementById("pic");n.src=o(e);if(t){n.crossOrigin="anonymous";$(".open_in_newtab").hide();document.getElementById("upload-btn").classList.remove("disabled")}else{n.removeAttribute("crossorigin");Swal.fire({icon:"warning",title:"请手动截图",html:"若使用该图作为背景图，请手动对海报截图。点击 “预览/下载图片” 按钮将导出失败。",footer:"这是由于，图片提供者设置了跨域政策。这可能是出于版权保护或服务器保护的目的。"});$(".open_in_newtab").show();document.getElementById("upload-btn").classList.add("disabled")}function o(e){var t=e;var n=/url\((.*)\)/;var o="";try{o=n.exec(t)[1].trim();o=o.replace(/["']/g,"")}catch(e){o="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7"}return o}let r=localStorage.getItem("settings");r=r?JSON.parse(r):{};r["pic_change"]=[e,t];localStorage.setItem("settings",JSON.stringify(r));return}function md2html(e){e=e.replace(/\n(?=\n\n)/g,"\n\n<br/>\n");let t=marked.parse(e,{breaks:true});return t}function text_change(e,t){let n="";try{n=md2html(e)}catch(t){n=`<p>${e}</p>`;n=n.replace(/\n/g,"</p><p>");console.log("md解析失败"+t)}$(`#${t}`).html(n);localStorage.setItem(`text-${t}`,e)}function check2val(e){const t=e.checked?0:1;const n=e.dataset.tf.split("|")[t];return n}function pic_source_type(e){$("[id*=pic_source_type]").hide();$(`#pic_source_type${e}`).show();if(e<=1)$("#tab3li").hide();else $("#tab3li").show();$(".tabs").tabs("updateTabIndicator")}function random_keyword(e){let t="";$.get(`https://pixabay.com/api/?key=6295509-b67e3d655066dca3360851316&per_page=10&q=${e}`,(function(n,o){for(i=0;i<9;i++){try{t+=`<div class="pic-eg" style="background-image:url('${n.hits[i].webformatURL}')"></div>`}catch(n){console.error(n);t+=`<div class="pic-eg" style="background-image:url('https://source.unsplash.com/80${i}x0/?${e}')"></div>`}}$("#pic_search_res").html(t);$(".pic-eg").on("click",(function(){const e=$(this).css("background-image");pic_change(e)}))}))}function pic_upload(e){var t=e.files[0];var n=window.URL.createObjectURL(t);pic_change(`url(${n})`)}function filter_reset(){document.getElementById("pic").setAttribute("style","");const e=[1,0,0,1,0,1,0];for(i=0;i<e.length;i++){$(`#tab3 div:eq(${i}) input`).val(`${e[i]}`);$(`#tab3 div:eq(${i}) span:eq(1)`).text(`${e[i]}`)}}function layout_change(func_name,param){function sentence_type(e){$(".letter_opt, .quote_opt").hide();let t={};let n={};switch(e){case"quote":$(".quote_opt").show();$("#text").removeClass("letter");t={"text-color":"#4d4135"};n={"text-align":"center","text-indent":"0em","text-padding1":"6.5em","text-padding2":"3.5em"};break;case"notice":$(".letter_opt").show();$("#text").addClass("notice");t={"font-family":"方正仿宋","title-font-family":"方正小标宋","text-color":"#4d4135","border-style":"solid","border-color":"#dfd6c5"};n={"text-align":"left","text-indent":"2em","text-padding1":"2.5em","text-padding2":"0.9em"};break;case"letter":$(".letter_opt").show();$("#text").addClass("letter");t={"font-family":"方正仿宋","title-font-family":"方正小标宋","text-color":"#4d4135","border-style":"solid","border-color":"#dfd6c5"};n={"text-align":"left","text-indent":"2em","text-padding1":"2.5em","text-padding2":"0.9em"};pic_change("linear-gradient(rgb(249, 233, 220), rgb(249, 233, 220))");break}Object.keys(n).forEach((function(e){cssvar_change(e,n[e])}));let o=localStorage.getItem("settings");o=o?JSON.parse(o):{};o=o["cssvar_change"]?o["cssvar_change"]:{};o=Object.keys(o);Object.keys(t).forEach((function(e){if(o.indexOf(e)==-1){cssvar_change(e,t[e])}}));e=="letter"&&cssvar_change("font-family","思源宋体","title-font-family","inherit");select_edit(document.getElementById("sentence_type"),e)}function letter_begin(e,t){document.getElementById("letter1").checked=e;document.getElementById("letter2").checked=t;e=e?"1":"0";t=t?"1":"0";$("#text").attr("data-letter-b",e+t)}function letter_end(e,t){document.getElementById("letter3").checked=e;document.getElementById("letter4").checked=t;e=e?1:0;t=t?1:0;$("#text").attr("data-letter-e",e+t)}eval(`${func_name}(${param})`);let settings=localStorage.getItem("settings");settings=settings?JSON.parse(settings):{};settings["layout_change"]=settings["layout_change"]?settings["layout_change"]:{};settings["layout_change"][func_name]=param;localStorage.setItem("settings",JSON.stringify(settings))}function select_edit(e,t){let n=Array.prototype.slice.call(e.options).find((e=>e.value==t));n.selected=true;e.parentNode.children[0].value=n.text;e.parentNode.children[0].setAttribute("style",n.getAttribute("style"));return{id:e.id,value:t}}function cssvar_change(){function e(e,t){let n=localStorage.getItem("settings");n=n?JSON.parse(n):{};n["cssvar_change"]=n["cssvar_change"]?n["cssvar_change"]:{};n["cssvar_change"][e]=t;localStorage.setItem("settings",JSON.stringify(n));return}for(let t=0;t<arguments.length;t=t+2){let n=arguments[t],o=arguments[t+1];if(n=="font-family"&&o!="revert"&&!document.fonts.check(`12px ${o}`)){Toast.fire(`“${o}”字体尚未加载完成，请稍等`,"","warning")}try{let e="";if(n.indexOf("filter")>-1)e="pic";else if(n.indexOf("text")>-1)e="text";else e="result";document.getElementById(e).style.setProperty(`--${n}`,o)}catch(e){console.error(`更改id为${arguments[t]}的控制元素失败：${e}`)}try{let t=document.getElementById(n);if(t.tagName.toLocaleLowerCase()=="input"){if(t.type=="checkbox"){let n=t.dataset.tf.split("|")[0];if(o==n)t.checked=true;else t.checked=false;e(t.id,o)}else{t.value=o.indexOf("#")>-1?o:parseFloat(o);e(t.id,t.value);let n=t.previousElementSibling;if(n.className.indexOf("switch-res")>-1)n.innerHTML=parseFloat(o)}}else if(t.tagName.toLocaleLowerCase()=="select"){select_edit(t,o);e(t.id,o)}else throw`id为${n}的显示元素类型不受支持`}catch(e){console.error(`更改id为${arguments[t]}的显示值失败：${e}`)}}}function capture(e=0){if(!document.getElementById("pic").complete){Swal.fire({icon:"error",title:"背景图片尚未加载完成",html:"请等待背景图片加载完成，或更换背景为渐变填充。",showConfirmButton:true});return false}$("#filter,#result").css("border-radius",0);if(e==4){let e=window.open("");e.document.write(`<html><head><title>对本页面截图</title><link rel="stylesheet" href="/css/standalone/poster-result.css" type="text/css"/><style>body{width: 100vw;}#result{transform:translateZ(0) scale(2);transform-origin: 0 0 0}</style></head><body><p style="font-size: 3vmax;margin-bottom: 3vh;">您可以滚动截图</p>${document.getElementById("result").outerHTML.replace(/contenteditable="true"/g,"")}</body></html>`);e.focus();$("#filter,#result").css("border-radius","5px");return true}Swal.fire({imageUrl:"/medias/loading/hourglass.svg",imageWidth:100,imageHeight:100,imageAlt:"loading",title:"请稍后",html:"图片生成中，预计需要10秒<br>网页可能暂时无响应，请稍安勿躁",showConfirmButton:false,timer:3e4,timerProgressBar:true,allowOutsideClick:false}).then((e=>{if(e.dismiss===Swal.DismissReason.timer){Swal.fire("请再试一次","超时","error")}}));var t=document.getElementById("result");var n={scale:e==2?1:2.5,only_style:"/css/standalone/poster-result.css"};domtoimage.toPng(t,n).then((function(t){let n=new Image;n.src=t;let a=/firefox/gi.test(navigator.userAgent)?`<div class="firefox swal2-icon swal2-warning swal2-icon-show" style="display: flex;"><div class="swal2-icon-content">!</div></div><div class="firefox"><svg xmlns:xlink="http://www.w3.org/1999/xlink" xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 100 100" version="1.1"><ellipse cx="50" cy="50" rx="24" ry="24" fill="#80e"></ellipse><path d="M50 42c-14-7-11-8-16-11-1-4-1-8 0-12-5 2-9 5-12 9-1-4-1.4-7-1-12C8 24 2 38 2 50c-0 31 26 49 48 49 22 0 48-16 48-49 0-5 0-9-3-16-9 21-23 40-45 40-8 0-23-4-23-25 7-2 16-3 23-7z" fill="#f73"></path><path d="M50 42c-17 6-20-8-35 0 3 6 7 7 11 7 0 20 12 26 24 26 19 0 37-9 45-41-7-17-23-19-29-34-9 6-15 14-16 26 12 0 24 10 24 24 0 15-14 23-24 23-5 0-19-2-21-17 2-6 8-8 16-9 3-1 4-3 5-5z" fill="#fc3"></path></svg> Firefox火狐浏览器可能<b class="text-color">不支持使用自定义字体和网络图片</b>。<br>如遇错误，请直接截图或使用Chrome或Edge浏览器。</div>`:false;switch(e){case 1:Swal.fire({html:`<img src="${t}" alt="生成图片" style="max-width:100%">`,footer:a,allowOutsideClick:false,showCloseButton:true,showConfirmButton:true,confirmButtonText:"下载",showCancelButton:true,cancelButtonText:"取消",showDenyButton:a?true:false,denyButtonText:"使用Edge浏览器打开",focusDeny:a?true:false,denyButtonColor:"#e64a19",customClass:{denyButton:"firefox"},preConfirm:()=>{if(window.navigator.userAgent.toLowerCase().match(/MicroMessenger/i)=="micromessenger"){alert("请长按图片保存")}else{o("分享图片",t);Swal.close()}return false},preDeny:()=>{window.open("microsoft-edge:https://lzc2002.gq/tools/tools-pc.html?src=/tools/poster/index.html");return false}});break;case 2:r(t);break;case 3:i(t);break;default:o("分享图片",t);break}$("#filter,#result").css("border-radius","5px")})).catch((function(e){console.warn(e);const t=/firefox/gi.test(navigator.userAgent)?`<div class="firefox swal2-icon swal2-warning swal2-icon-show" style="display: flex;"><div class="swal2-icon-content">!</div></div><div class="firefox"> 如在Firefox火狐浏览器内遇到错误，请尝试更换至Edge或Chrome浏览器。</div>`:false;Swal.fire({icon:"error",title:"请再试一次",html:"若错误持续出现，请更换背景图片。",footer:"错误信息："+e.toString(),showDenyButton:t?true:false,denyButtonText:"使用Edge浏览器打开",focusDeny:t?true:false,denyButtonColor:"#e64a19",preDeny:()=>{window.open("microsoft-edge:https://lzc2002.gq/tools/tools-pc.html?src=/tools/poster/index.html");return false}})}));function o(e,t){var n=document.createElement("a");n.href=t;n.download=e;let o=document.createEvent("MouseEvents");o.initMouseEvent("click",true,false,window,0,0,0,0,0,false,false,false,false,0,null);n.dispatchEvent(o);Swal.fire({icon:"success",title:"即将弹出下载窗口",timer:3e3})}function r(e){AV.init({appId:"3yz9VMMFTU7t2AjXwqOzRtJK-MdYXbMMI",appKey:"yWPKu7eizq6iQgRWuBlpRyPa",serverURL:"https://leancloud.lzc2002.gq",serverURLs:"https://leancloud.lzc2002.gq"});const t=AV.Object.extend("Poster");const n=new t;const o=document.getElementById("content").innerText;const r=document.getElementById("foot").innerText;const i=typeof returnCitySN!=="undefined"&&returnCitySN["cip"]?returnCitySN["cip"]:"-1";n.set("content",o);n.set("foot",r);n.set("dataurl",e);n.save().then((e=>{console.log(`保存成功。objectId: ${e.id}`);Swal.fire({icon:"success",title:"上传成功",html:`存档编号: ${e.id}`,confirmButtonText:"去看看",showCancelButton:true,cancelButtonText:"好的"}).then((e=>{if(e.value)window.open("/tools/poster/result.html")}))}),(e=>{console.error("leancloud error:"+e);Swal.fire({icon:"error",title:"上传失败",confirmButtonText:"好的"})}))}async function i(e){try{const t=await fetch(e);const n=await t.blob();await navigator.clipboard.write([new ClipboardItem({[n.type]:n})]).then((()=>{Toast.fire({icon:"success",title:"复制成功"})}),(e=>{const t=e.toString().indexOf("Write permission denied")>-1?true:false;Swal.fire({title:t?"请允许剪切板权限":"复制失败",html:t?"剪切板访问被拒绝":"请直接下载图片",icon:"error",footer:e});console.error(e)}))}catch(e){Swal.fire({icon:"error",title:"复制失败",footer:e})}}}function random_quote(){layout_change("sentence_type","quote");cssvar_change("text-color","#ffffff","border-style","none");const e={a:"japanese cartoon",b:"comic",c:"video game",d:"literature",e:"original",f:"blur",g:"wallpaper",h:"film",i:"中国风",j:"cloud",k:"philosophy",l:"snarky"};$.get("https://v1.hitokoto.cn/?time="+(new Date).getTime(),(function(t,n){$("#content").text(t.hitokoto);$("#foot").text(`${t.from_who?t.from_who:t.creator}《${t.from}》`);cssvar_change("filter-bright","0.4");let o="",r=100;$.get(`https://pixabay.com/api/?key=6295509-b67e3d655066dca3360851316&per_page=${r}&q=${e[t.type]}`,(function(n,i){try{let e=Math.floor(Math.random()*r);o=n.hits[e].webformatURL}catch(n){console.error(n);o="https://source.unsplash.com/800x0/?"+e[t.type]+"&"+(new Date).getTime()}pic_change(`url(${o})`)}))}))}function menu(e){let t=e.firstChild.firstChild.style;if(t.transform==""){t.transform="rotate(180deg)";document.getElementsByTagName("header")[0].style.display="block"}else{t.transform="";document.getElementsByTagName("header")[0].style.display="none"}}async function random_gpt(){ask_gpt().then((e=>{const t=e[0];const n=e[1];if(document.getElementById("gpt_res").innerHTML)document.getElementById("gpt_res").innerHTML="<p>生成中...上一次的结果：</p>"+document.getElementById("gpt_res").innerHTML;swal_rendering();const o={url:"https://api.openai.com/v1/completions",method:"POST",timeout:0,headers:{Authorization:"Bearer "+t,"Content-Type":"application/json"},data:JSON.stringify({model:"text-davinci-003",prompt:`请围绕这句话进行文学创作（字数在150字以内）：${n}\n请不要在回答中复述这句话。`,max_tokens:1024,temperature:1,user:fgp})};$.ajax(o).done((function(e){let t=e.choices[0].text.trim().replace(/\n{2,}/g,"\n");t="<p>"+t.replace(/\n/g,"</p><p>")+"</p>";document.getElementById("gpt_res").innerHTML="<p>“"+n+"”</p>"+t;Swal.fire({title:"成功",icon:"success",html:"生成卡片？",confirmButtonText:"生成",cancelButtonText:"取消",showCancelButton:true}).then((e=>{if(e.value){layout_change("sentence_type","letter");text_change(t,"content");layout_change("letter_begin",[0,0]);layout_change("letter_end",[0,0]);document.querySelectorAll("[id*=letter]").forEach((e=>e.checked=false));cssvar_change("text-padding1","0.8em")}}))})).fail((function(e){console.error(e);Swal.fire({title:"获取失败",icon:"error",footer:e.responseJSON.error.type=="invalid_request_error"?"API错误":"未知错误"})}))}))}function swal_rendering(){Swal.fire({title:"正在连接Chat GPT",html:"可关闭对话框，但不要关闭网页",imageUrl:"/medias/loading/hourglass.svg",imageWidth:100,imageHeight:100,imageAlt:"loading",showConfirmButton:false,showCloseButton:!0})}async function random_gpt_pic(){ask_gpt().then((e=>{const t=e[1];const n=e[0];const o=new Headers;o.append("Authorization",`Bearer ${n}`);o.append("Content-Type","application/json");const r=JSON.stringify({prompt:t,size:"512x512",user:fgp});const i={method:"POST",headers:o,body:r,redirect:"follow"};swal_rendering();return i})).then((requestOptions=>fetch("https://api.openai.com/v1/images/generations",requestOptions).then((e=>e.text())).then((result=>{try{result=eval("("+result+")");if(result.error)throw new Error(result.error.message,{message:result.error.code,cause:result.error.type});const url=result.data[0].url;const html=`<div class="pic-eg gptpic" style="background-image:url('${url}')"></div>`;document.getElementById("pic_gpt_res").innerHTML+=html;pic_change(`background-image:url('${url}')`,false);$(".pic-eg.gptpic").on("click",(function(){const e=$(this).css("background-image");pic_change(e,false)}));cssvar_change("filter-bright","0.5");document.getElementById("pic").onload="Toast.fire({title:'成功',icon:'success'});this.onload=null"}catch(e){console.error(e);Swal.fire({title:"添加图片失败",footer:e,icon:"error"})}})).catch((e=>{Swal.fire({title:"生成失败",footer:e.toString().replace(/Failed to fetch/g,"无法连接到ChatGPT"),icon:"error"});console.error(e)}))))}async function ask_gpt(){const e=document.getElementById("content").innerText;const t=localStorage.getItem("gpt_key");const{value:[n,o]}=await Swal.fire({title:"Chat GPT API调用",html:` \n        <form class="col s12 row" style="margin-bottom: 0;">\n          \n            <div class="input-field col s12">\n              <input id="gpt-input1" type="text" value=${t?t:""}>\n              <label for="gpt-input1">API密钥</label>\n            </div>\n            <div class="input-field col s12" style="margin-bottom: 0">\n              <input id="gpt-input2" type="text" value="${e}">\n              <label for="gpt-input2">围绕主题</label>\n            </div>\n        </form><style onload="M.updateTextFields()"></style>\n        `,footer:`<a href="https://platform.openai.com/account/api-keys">获取API密钥</a>`,focusConfirm:false,showCancelButton:true,preConfirm:()=>[document.getElementById("gpt-input1").value,document.getElementById("gpt-input2").value],customClass:{htmlContainer:"row"}});localStorage.setItem("gpt_key",n);const r=new Promise((function(e,t){if(n&&o)e([n,o]);else t()}));return r}document.fonts.onloadingdone=function(e){if(e.fontfaces.length>9)Toast.fire("",e.fontfaces.length+"种字体加载完成","success")};